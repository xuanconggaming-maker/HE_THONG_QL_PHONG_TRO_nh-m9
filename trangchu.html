<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trang Ri√™ng Kh√°ch Thu√™</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", sans-serif;
      }
      body {
        background: #f4f7f6;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
      }
      .card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 450px;
        text-align: center;
      }
      .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 16px;
      }
      .total-price {
        font-size: 24px;
        color: #d32f2f;
        font-weight: bold;
        margin: 15px 0;
        border-top: 1px solid #eee;
        padding-top: 10px;
      }
      .btn-pay {
        background: #28a745;
        color: white;
        border: none;
        padding: 15px;
        border-radius: 8px;
        width: 100%;
        font-size: 18px;
        cursor: pointer;
        font-weight: bold;
      }
      #btnConfirm {
        background: #1a73e8;
        color: white;
        border: none;
        padding: 15px;
        border-radius: 8px;
        width: 100%;
        margin-top: 10px;
        cursor: pointer;
        display: none;
        font-weight: bold;
      }
      .qr-area {
        display: none;
        margin-top: 20px;
        border: 1px dashed #ccc;
        padding: 10px;
        border-radius: 10px;
      }
      .qr-area img {
        width: 100%;
        border-radius: 10px;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1 id="roomTitle" style="color: #1a73e8; margin-bottom: 10px">
        PH√íNG ...
      </h1>
      <p
        id="thangHienTai"
        style="font-weight: bold; color: #666; margin-bottom: 20px"
      >
        H√≥a ƒë∆°n th√°ng: --
      </p>

      <div id="billContent">
        <div class="info-row">
          <p>Ti·ªÅn ph√≤ng:</p>
          <p><strong id="phongVal">0</strong> ƒë</p>
        </div>
        <div class="info-row">
          <p>Ti·ªÅn ƒëi·ªán:</p>
          <p><strong id="dienVal">0</strong> ƒë</p>
        </div>
        <div class="info-row">
          <p>Ti·ªÅn n∆∞·ªõc:</p>
          <p><strong id="nuocVal">0</strong> ƒë</p>
        </div>
        <div class="total-price">T·ªîNG: <span id="totalVal">0</span> ƒë</div>
        <button class="btn-pay" id="btnPay" onclick="showQR()">
          THANH TO√ÅN QUA QR
        </button>
      </div>

      <div
        id="paidMessage"
        style="display: none; color: green; font-weight: bold; padding: 20px"
      >
        üéâ B·∫°n ƒë√£ thanh to√°n h√≥a ƒë∆°n th√°ng n√†y!
      </div>

      <div id="qrArea" class="qr-area">
        <img id="qrImage" src="" alt="M√£ QR" />
        <p style="margin: 10px 0; font-weight: bold">
          VU XUAN CONG - 4619092006
        </p>
        <button id="btnConfirm" onclick="handleConfirm()">
          T√îI ƒê√É CHUY·ªÇN KHO·∫¢N XONG
        </button>
      </div>

      <a
        href="index.html"
        style="
          display: block;
          margin-top: 20px;
          color: #888;
          text-decoration: none;
        "
        >ƒêƒÉng xu·∫•t</a
      >
    </div>

    <script>
      const room = sessionStorage.getItem("roomNumber");
      const bills = JSON.parse(localStorage.getItem("duLieuHoaDon")) || {};
      const myData = bills[room] || {
        thang: "-",
        phong: 0,
        dien: 0,
        nuoc: 0,
        isPaid: false,
      };

      document.getElementById("roomTitle").innerText =
        "PH√íNG " + room.toUpperCase();
      document.getElementById("thangHienTai").innerText =
        "H√≥a ƒë∆°n th√°ng: " + myData.thang;

      // N·∫øu ƒë√£ thanh to√°n th√¨ ·∫©n h√≥a ƒë∆°n, hi·ªán th√¥ng b√°o
      if (myData.isPaid) {
        document.getElementById("billContent").style.display = "none";
        document.getElementById("paidMessage").style.display = "block";
      } else {
        const total =
          parseInt(myData.phong) +
          parseInt(myData.dien) +
          parseInt(myData.nuoc);
        document.getElementById("phongVal").innerText = parseInt(
          myData.phong,
        ).toLocaleString();
        document.getElementById("dienVal").innerText = parseInt(
          myData.dien,
        ).toLocaleString();
        document.getElementById("nuocVal").innerText = parseInt(
          myData.nuoc,
        ).toLocaleString();
        document.getElementById("totalVal").innerText = total.toLocaleString();

        window.currentTotal = total;
        window.currentThang = myData.thang;
      }

      function showQR() {
        const desc = `Thanh toan phong ${room.toUpperCase()} thang ${window.currentThang}`;
        document.getElementById("qrImage").src =
          `https://img.vietqr.io/image/mbbank-4619092006-compact.png?amount=${window.currentTotal}&addInfo=${desc}`;
        document.getElementById("qrArea").style.display = "block";
        document.getElementById("btnConfirm").style.display = "block";
        document.getElementById("btnPay").style.display = "none";
      }

      function handleConfirm() {
        // 1. C·∫≠p nh·∫≠t tr·∫°ng th√°i h√≥a ƒë∆°n c·ªßa ph√≤ng n√†y th√†nh ƒê√É THANH TO√ÅN
        bills[room].isPaid = true;
        localStorage.setItem("duLieuHoaDon", JSON.stringify(bills));

        // 2. L∆∞u v√†o l·ªãch s·ª≠ cho Admin
        let history = JSON.parse(localStorage.getItem("lichSuThanhToan")) || [];
        history.push({
          time: new Date().toLocaleString("vi-VN"),
          room: room.toUpperCase(),
          thangAt: window.currentThang,
          amount: window.currentTotal.toLocaleString(),
        });
        localStorage.setItem("lichSuThanhToan", JSON.stringify(history));

        alert("C·∫£m ∆°n! B·∫°n ƒë√£ b√°o thanh to√°n th√†nh c√¥ng.");
        location.reload(); // Reload ƒë·ªÉ s·ªë ti·ªÅn v·ªÅ 0 v√† hi·ªán ch·ªØ "ƒê√£ thanh to√°n"
      }
    </script>
  </body>
</html>
